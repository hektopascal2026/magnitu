{% extends "layout.html" %}
{% block title %}Top 30 — Magnitu{% endblock %}

{% block content %}
<div class="dashboard-section">
    <h2>Top 30 Highest-Scored Entries</h2>
    <p class="section-desc">These are the entries the model considers most relevant across all time. Compare the model's prediction against your labels to validate accuracy.</p>

    {% if not active_model %}
        <div class="empty-state"><p>No model trained yet. Train a model first to see scores.</p></div>
    {% elif not top_entries %}
        <div class="empty-state"><p>No entries scored. Pull entries from Seismo first.</p></div>
    {% else %}
        <!-- Accuracy Summary -->
        <div class="top-accuracy-summary">
            {% if accuracy is not none %}
                <div class="stat-card">
                    <div class="stat-value">{{ accuracy }}%</div>
                    <div class="stat-label">Accuracy ({{ correct_count }}/{{ labeled_count }})</div>
                </div>
            {% endif %}
            <div class="stat-card">
                <div class="stat-value">{{ top_entries | length }}</div>
                <div class="stat-label">Entries shown</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ labeled_count }}</div>
                <div class="stat-label">Have your label</div>
            </div>
        </div>

        <!-- Entries -->
        <div class="entries-section">
            {% for item in top_entries %}
                {% set e = item.entry %}
                {% set s = item.score %}
                <div class="entry-card {% if item.user_label %}labeled labeled-{{ item.user_label }}{% endif %} {% if item.match == false %}top-mismatch{% endif %}"
                     style="opacity: 1;">
                    <div class="entry-header">
                        <span class="entry-source-tag source-{{ e.source_type }}">{{ e.source_type }}</span>
                        {% if e.source_category %}
                            <span class="entry-category">{{ e.source_category }}</span>
                        {% endif %}
                        <span class="top-rank">#{{ loop.index }}</span>
                        <span class="top-score-pill top-badge-{{ s.predicted_label }}">
                            {{ (s.relevance_score * 100) | round(0) }} · {{ s.predicted_label | replace('_', ' ') }}
                        </span>
                        {% if e.published_date %}
                            <span class="entry-date">{{ e.published_date[:10] }}</span>
                        {% endif %}
                    </div>

                    <h3 class="entry-title">
                        {% if e.link %}
                            <a href="{{ e.link }}" target="_blank" rel="noopener">{{ e.title }}</a>
                        {% else %}
                            {{ e.title }}
                        {% endif %}
                    </h3>

                    {% if e.description %}
                        <div class="entry-content">{{ e.description[:300] }}{% if e.description|length > 300 %}...{% endif %}</div>
                    {% endif %}

                    <div class="top-entry-meta">
                        {% if e.source_name %}
                            <span class="entry-source">{{ e.source_name }}</span>
                        {% endif %}
                        <div class="top-validation">
                            {% if item.user_label %}
                                <span class="entry-current-label label-{{ item.user_label }}" data-role="current-label">
                                    {{ item.user_label | replace('_', ' ') }}
                                </span>
                                {% if item.match %}
                                    <span class="top-verdict-badge top-correct-bg" data-role="verdict">match</span>
                                {% else %}
                                    <span class="top-verdict-badge top-wrong-bg" data-role="verdict">mismatch</span>
                                {% endif %}
                            {% else %}
                                <span class="top-no-label" data-role="no-label">not labeled</span>
                            {% endif %}
                            <button class="btn-reclassify" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}" data-predicted="{{ s.predicted_label }}" title="Assign or change your label">Reclassify</button>
                        </div>
                    </div>

                    <!-- Inline label buttons (hidden until Reclassify is clicked) -->
                    <div class="top-label-buttons" data-for="{{ e.entry_type }}-{{ e.entry_id }}" style="display:none;">
                        <button class="label-btn label-btn-investigation {% if item.user_label == 'investigation_lead' %}active{% endif %}" data-label="investigation_lead" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}">
                            <span class="label-key">1</span> Investigation
                        </button>
                        <button class="label-btn label-btn-important {% if item.user_label == 'important' %}active{% endif %}" data-label="important" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}">
                            <span class="label-key">2</span> Important
                        </button>
                        <button class="label-btn label-btn-background {% if item.user_label == 'background' %}active{% endif %}" data-label="background" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}">
                            <span class="label-key">3</span> Background
                        </button>
                        <button class="label-btn label-btn-noise {% if item.user_label == 'noise' %}active{% endif %}" data-label="noise" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}">
                            <span class="label-key">4</span> Noise
                        </button>
                    </div>

                    {% if s.probabilities %}
                        <div class="top-probabilities">
                            {% for cls, prob in s.probabilities.items() %}
                                <span class="top-prob">{{ cls | replace('_', ' ') }}: {{ (prob * 100) | round(0) }}%</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Toggle label buttons on Reclassify click
    document.addEventListener('click', function(e) {
        var reclBtn = e.target.closest('.btn-reclassify');
        if (reclBtn) {
            var key = reclBtn.dataset.entryType + '-' + reclBtn.dataset.entryId;
            var panel = document.querySelector('.top-label-buttons[data-for="' + key + '"]');
            if (panel) {
                var visible = panel.style.display !== 'none';
                // Hide all other open panels
                document.querySelectorAll('.top-label-buttons').forEach(function(p) {
                    p.style.display = 'none';
                });
                panel.style.display = visible ? 'none' : 'flex';
            }
            return;
        }

        // Handle label button clicks
        var labelBtn = e.target.closest('.top-label-buttons .label-btn');
        if (!labelBtn) return;

        var entryType = labelBtn.dataset.entryType;
        var entryId = labelBtn.dataset.entryId;
        var label = labelBtn.dataset.label;
        var card = labelBtn.closest('.entry-card');
        var panel = labelBtn.closest('.top-label-buttons');
        var predicted = card.querySelector('.btn-reclassify').dataset.predicted;

        var formData = new FormData();
        formData.append('entry_type', entryType);
        formData.append('entry_id', entryId);
        formData.append('label', label);

        fetch('/api/label', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.success) return;

                // Update active state on buttons
                panel.querySelectorAll('.label-btn').forEach(function(b) {
                    b.classList.toggle('active', b.dataset.label === label);
                });

                // Update card border styling
                card.className = card.className.replace(/labeled-\S+/g, '');
                if (!card.classList.contains('labeled')) card.classList.add('labeled');
                card.classList.add('labeled-' + label);

                // Update mismatch state
                var isMatch = (label === predicted);
                card.classList.toggle('top-mismatch', !isMatch);

                // Update the validation area
                var validation = card.querySelector('.top-validation');
                var currentLabel = validation.querySelector('[data-role="current-label"]');
                var verdict = validation.querySelector('[data-role="verdict"]');
                var noLabel = validation.querySelector('[data-role="no-label"]');

                if (noLabel) noLabel.remove();

                if (!currentLabel) {
                    currentLabel = document.createElement('span');
                    currentLabel.setAttribute('data-role', 'current-label');
                    validation.insertBefore(currentLabel, validation.querySelector('.btn-reclassify'));
                }
                currentLabel.className = 'entry-current-label label-' + label;
                currentLabel.textContent = label.replace(/_/g, ' ');

                if (!verdict) {
                    verdict = document.createElement('span');
                    verdict.setAttribute('data-role', 'verdict');
                    validation.insertBefore(verdict, validation.querySelector('.btn-reclassify'));
                }
                verdict.className = 'top-verdict-badge ' + (isMatch ? 'top-correct-bg' : 'top-wrong-bg');
                verdict.textContent = isMatch ? 'match' : 'mismatch';

                // Collapse the label panel after a moment
                setTimeout(function() { panel.style.display = 'none'; }, 300);

                // Recalculate and update accuracy summary
                updateAccuracy();
            })
            .catch(function(err) {
                if (typeof flash === 'function') flash('Error: ' + err.message, 'error');
            });
    });

    function updateAccuracy() {
        var cards = document.querySelectorAll('.entries-section .entry-card');
        var labeled = 0, correct = 0;
        cards.forEach(function(c) {
            var cl = c.querySelector('[data-role="current-label"]');
            var vd = c.querySelector('[data-role="verdict"]');
            if (cl) {
                labeled++;
                if (vd && vd.textContent.trim() === 'match') correct++;
            }
        });
        // Update stat cards
        var statCards = document.querySelectorAll('.top-accuracy-summary .stat-card');
        if (statCards.length >= 3 && labeled > 0) {
            var acc = Math.round(correct / labeled * 1000) / 10;
            statCards[0].querySelector('.stat-value').textContent = acc + '%';
            statCards[0].querySelector('.stat-label').textContent = 'Accuracy (' + correct + '/' + labeled + ')';
            statCards[2].querySelector('.stat-value').textContent = labeled;
        }
    }
})();
</script>
{% endblock %}
