{% extends "layout.html" %}
{% block title %}Top 30 — Magnitu{% endblock %}

{% block content %}
<div class="dashboard-section">
    <h2>Top 30 Highest-Scored Entries</h2>
    <p class="section-desc">These are the entries the model considers most relevant across all time. Compare the model's prediction against your labels to validate accuracy.</p>

    {% if not active_model %}
        <div class="empty-state"><p>No model trained yet. Train a model first to see scores.</p></div>
    {% elif not top_entries %}
        <div class="empty-state"><p>No entries scored. Pull entries from Seismo first.</p></div>
    {% else %}
        <!-- Accuracy Summary -->
        <div class="top-accuracy-summary">
            {% if accuracy is not none %}
                <div class="stat-card">
                    <div class="stat-value">{{ accuracy }}%</div>
                    <div class="stat-label">Accuracy ({{ correct_count }}/{{ labeled_count }})</div>
                </div>
            {% endif %}
            <div class="stat-card">
                <div class="stat-value">{{ top_entries | length }}</div>
                <div class="stat-label">Entries shown</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ labeled_count }}</div>
                <div class="stat-label">Have your label</div>
            </div>
        </div>

        <!-- Entries -->
        <div class="entries-section">
            {% for item in top_entries %}
                {% set e = item.entry %}
                {% set s = item.score %}
                <div class="entry-card {% if item.user_label %}labeled labeled-{{ item.user_label }}{% endif %}"
                     data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}" data-predicted="{{ s.predicted_label }}">

                    <!-- Header: source tag (lex only) left, rank|score box right -->
                    <div class="top-card-header">
                        <div class="top-card-header-left">
                            {% if e.source_type and e.source_type.startswith('lex') %}
                                <span class="entry-source-tag source-{{ e.source_type }}">{{ e.source_type }}</span>
                                {% if e.source_category %}
                                    <span class="entry-category">{{ e.source_category }}</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="top-rank-score">
                            <span class="top-rank-half">#{{ loop.index }}</span>
                            <span class="top-score-half">{{ (s.relevance_score * 100) | round(0) }}</span>
                        </div>
                    </div>

                    <!-- Title -->
                    <h3 class="entry-title">
                        {% if e.link %}
                            <a href="{{ e.link }}" target="_blank" rel="noopener">{{ e.title }}</a>
                        {% else %}
                            {{ e.title }}
                        {% endif %}
                    </h3>

                    <!-- Description -->
                    {% if e.description %}
                        <div class="entry-content">{{ e.description[:200] }}{% if e.description|length > 200 %}...{% endif %}</div>
                    {% endif %}

                    <!-- Footer: reclassify+why left, source+date right -->
                    <div class="top-card-footer">
                        <div class="top-card-footer-left">
                            <button class="btn-reclassify" title="Assign or change your label">Reclassify</button>
                            <button class="btn-why" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}" title="Why did the model score this entry?">Why?</button>
                        </div>
                        <div class="top-card-footer-right">
                            <span class="entry-source">{{ e.source_name or e.source_type }}</span>
                            {% if e.published_date %}
                                <span class="entry-date">{{ e.published_date[:10] }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Why explanation (hidden until Why? clicked) -->
                    <div class="top-why-panel" style="display:none;"></div>

                    <!-- Reclassify label buttons (hidden until clicked) -->
                    <div class="top-label-buttons" data-for="{{ e.entry_type }}-{{ e.entry_id }}" style="display:none;">
                        <button class="label-btn label-btn-investigation {% if item.user_label == 'investigation_lead' %}active{% endif %}" data-label="investigation_lead" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}">
                            <span class="label-key">1</span> Investigation
                        </button>
                        <button class="label-btn label-btn-important {% if item.user_label == 'important' %}active{% endif %}" data-label="important" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}">
                            <span class="label-key">2</span> Important
                        </button>
                        <button class="label-btn label-btn-background {% if item.user_label == 'background' %}active{% endif %}" data-label="background" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}">
                            <span class="label-key">3</span> Background
                        </button>
                        <button class="label-btn label-btn-noise {% if item.user_label == 'noise' %}active{% endif %}" data-label="noise" data-entry-type="{{ e.entry_type }}" data-entry-id="{{ e.entry_id }}">
                            <span class="label-key">4</span> Noise
                        </button>
                    </div>

                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    document.addEventListener('click', function(e) {
        /* ── Reclassify toggle ── */
        var reclBtn = e.target.closest('.btn-reclassify');
        if (reclBtn) {
            var card = reclBtn.closest('.entry-card');
            var panel = card.querySelector('.top-label-buttons');
            if (panel) {
                var visible = panel.style.display !== 'none';
                document.querySelectorAll('.top-label-buttons').forEach(function(p) { p.style.display = 'none'; });
                panel.style.display = visible ? 'none' : 'flex';
            }
            return;
        }

        /* ── Why? button ── */
        var whyBtn = e.target.closest('.btn-why');
        if (whyBtn) {
            var card = whyBtn.closest('.entry-card');
            var whyPanel = card.querySelector('.top-why-panel');
            if (whyPanel.style.display !== 'none') {
                whyPanel.style.display = 'none';
                whyBtn.textContent = 'Why?';
                return;
            }
            whyBtn.textContent = '…';
            var entryType = whyBtn.dataset.entryType;
            var entryId = whyBtn.dataset.entryId;
            fetch('/api/explain/' + encodeURIComponent(entryType) + '/' + encodeURIComponent(entryId))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.error) {
                        whyPanel.innerHTML = '<span class="why-error">' + data.error + '</span>';
                    } else {
                        var features = (data.top_features || []).slice(0, 8);
                        var html = '<span class="why-label">Magnitu: ' + (data.predicted_label || '').replace(/_/g, ' ') +
                            ' (' + Math.round((data.confidence || 0) * 100) + '% confidence)</span>';
                        html += '<span class="why-features">';
                        features.forEach(function(f, i) {
                            var sign = f.weight >= 0 ? '+' : '';
                            html += (i > 0 ? '  ' : '') +
                                '<span class="why-feat">' + f.feature + ' ' + sign + parseFloat(f.weight).toFixed(2) + '</span>';
                        });
                        html += '</span>';
                        whyPanel.innerHTML = html;
                    }
                    whyPanel.style.display = 'block';
                    whyBtn.textContent = 'Why?';
                })
                .catch(function() {
                    whyPanel.innerHTML = '<span class="why-error">Could not load explanation.</span>';
                    whyPanel.style.display = 'block';
                    whyBtn.textContent = 'Why?';
                });
            return;
        }

        /* ── Label button clicks ── */
        var labelBtn = e.target.closest('.top-label-buttons .label-btn');
        if (!labelBtn) return;

        var entryType = labelBtn.dataset.entryType;
        var entryId = labelBtn.dataset.entryId;
        var label = labelBtn.dataset.label;
        var card = labelBtn.closest('.entry-card');
        var panel = labelBtn.closest('.top-label-buttons');
        var predicted = card.dataset.predicted;

        var formData = new FormData();
        formData.append('entry_type', entryType);
        formData.append('entry_id', entryId);
        formData.append('label', label);

        fetch('/api/label', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.success) return;
                panel.querySelectorAll('.label-btn').forEach(function(b) {
                    b.classList.toggle('active', b.dataset.label === label);
                });
                card.className = card.className.replace(/labeled-\S+/g, '');
                if (!card.classList.contains('labeled')) card.classList.add('labeled');
                card.classList.add('labeled-' + label);
                setTimeout(function() { panel.style.display = 'none'; }, 300);
                updateAccuracy();
            });
    });

    function updateAccuracy() {
        var cards = document.querySelectorAll('.entries-section .entry-card');
        var labeled = 0, correct = 0;
        cards.forEach(function(c) {
            if (c.classList.contains('labeled')) {
                labeled++;
                var userLabel = (c.className.match(/labeled-(\S+)/) || [])[1];
                if (userLabel === c.dataset.predicted) correct++;
            }
        });
        var statCards = document.querySelectorAll('.top-accuracy-summary .stat-card');
        if (statCards.length >= 3 && labeled > 0) {
            var acc = Math.round(correct / labeled * 1000) / 10;
            statCards[0].querySelector('.stat-value').textContent = acc + '%';
            statCards[0].querySelector('.stat-label').textContent = 'Accuracy (' + correct + '/' + labeled + ')';
            statCards[2].querySelector('.stat-value').textContent = labeled;
        }
    }
})();
</script>
{% endblock %}
