{% extends "layout.html" %}
{% block title %}Model — Magnitu{% endblock %}

{% block content %}
<div class="dashboard-section">
    <h2>Model Profile</h2>

    {% if profile %}
    <!-- Model Identity -->
    <div style="padding: 16px; border: 2px solid #000000; background: #fafafa; margin-bottom: 16px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div class="form-group">
                <label style="font-size: 12px; font-weight: 600;">Model Name (fixed)</label>
                <input type="text" value="{{ profile.model_name }}" readonly
                       style="width: 100%; padding: 8px 10px; border: 2px solid #000000; font-family: inherit; font-size: 14px; box-sizing: border-box; background: #f5f5f5; cursor: default;">
            </div>
            <div class="form-group">
                <label style="font-size: 12px; font-weight: 600;">UUID (read-only)</label>
                <input type="text" value="{{ profile.model_uuid }}" readonly
                       style="width: 100%; padding: 8px 10px; border: 2px solid #000000; font-family: monospace; font-size: 12px; background: #f5f5f5; box-sizing: border-box; cursor: pointer;"
                       onclick="this.select(); document.execCommand('copy');" title="Click to copy">
            </div>
        </div>
        <div class="form-group" style="margin-bottom: 12px;">
            <label style="font-size: 12px; font-weight: 600;">Description</label>
            <input type="text" id="profileDesc" value="{{ profile.description or '' }}"
                   placeholder="Short description of what this model is trained to detect"
                   style="width: 100%; padding: 8px 10px; border: 2px solid #000000; font-family: inherit; font-size: 14px; box-sizing: border-box;">
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
            <button class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
            <span style="font-size: 12px; color: #000000;">Created: {{ profile.created_at[:10] if profile.created_at else 'Unknown' }}</span>
        </div>
    </div>

    <!-- Current Metrics -->
    {% if active_model %}
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
        <div class="stat-card">
            <div class="stat-value">v{{ active_model.version }}</div>
            <div class="stat-label">Version</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.1f"|format(active_model.accuracy * 100) }}%</div>
            <div class="stat-label">Accuracy</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ active_model.label_count }}</div>
            <div class="stat-label">Labels Trained</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ label_count }}</div>
            <div class="stat-label">Labels Total</div>
        </div>
    </div>
    {% else %}
    <div class="message message-info" style="margin-bottom: 16px;">No model trained yet. Label entries and train to get started.</div>
    {% endif %}

    <!-- Export / Import -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div style="padding: 16px; border: 2px solid #000000;">
            <h3 style="margin-bottom: 8px;">Export</h3>
            <p style="font-size: 12px; margin-bottom: 12px; line-height: 1.5;">
                Download this model as a <code>.magnitu</code> file. Includes the trained model, all labels, and the recipe. Share it with colleagues so they can continue training.
            </p>
            <button class="btn" id="exportBtn" {% if not active_model and label_count == 0 %}disabled title="Nothing to export yet"{% endif %}>
                Download .magnitu
            </button>
            <span id="exportStatus" style="font-size: 12px; margin-left: 8px;"></span>
        </div>
        <div style="padding: 16px; border: 2px solid #000000;">
            <h3 style="margin-bottom: 8px;">Import</h3>
            <p style="font-size: 12px; margin-bottom: 12px; line-height: 1.5;">
                Load a <code>.magnitu</code> file to merge labels. If the imported model is newer than yours, the trained model is loaded too. Otherwise, retrain after import.
            </p>
            <form id="importForm" enctype="multipart/form-data" style="display: flex; gap: 8px; align-items: center;">
                <input type="file" id="importFile" accept=".magnitu" style="font-size: 12px; flex: 1;">
                <button type="submit" class="btn">Import</button>
            </form>
            <div id="importStatus" style="margin-top: 8px;"></div>
        </div>
    </div>

    <!-- Export as New Model -->
    <div style="padding: 16px; border: 2px solid #000000; margin-bottom: 16px;">
        <h3 style="margin-bottom: 8px;">Export as New Model</h3>
        <p style="font-size: 12px; margin-bottom: 12px; line-height: 1.5;">
            Create a new, independent model based on this one. All labels and the trained model are included.
            The new model's metadata will permanently record that it was based on <strong>{{ profile.model_name }}</strong>.
        </p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">New Model Name</label>
                <input type="text" id="forkName" placeholder="e.g. pascal2"
                       style="width: 100%; padding: 8px 10px; border: 2px solid #000000; font-family: inherit; font-size: 14px; box-sizing: border-box;">
            </div>
            <div>
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Description</label>
                <input type="text" id="forkDesc" placeholder="What will this model focus on?"
                       style="width: 100%; padding: 8px 10px; border: 2px solid #000000; font-family: inherit; font-size: 14px; box-sizing: border-box;">
            </div>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
            <button class="btn" id="forkBtn" {% if not active_model and label_count == 0 %}disabled title="Nothing to export yet"{% endif %}>
                Create &amp; Download .magnitu
            </button>
            <span id="forkStatus" style="font-size: 12px;"></span>
        </div>
        <p style="font-size: 11px; color: #666; margin-top: 8px;">
            Based on: <strong>{{ profile.model_name }}</strong> ({{ profile.model_uuid[:8] }}…) — this lineage cannot be removed from the exported file.
        </p>
    </div>

    <!-- Version History -->
    {% if models %}
    <div style="padding: 16px; border: 2px solid #000000;">
        <h3 style="margin-bottom: 12px;">Version History</h3>
        <table class="history-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>Version</th>
                    <th>Trained</th>
                    <th>Labels</th>
                    <th>Accuracy</th>
                    <th>F1</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for m in models %}
                <tr class="{% if m.is_active %}active-model{% endif %}">
                    <td>v{{ m.version }}</td>
                    <td>{{ m.trained_at[:16] if m.trained_at else '' }}</td>
                    <td>{{ m.label_count }}</td>
                    <td>{{ "%.1f"|format(m.accuracy * 100) }}%</td>
                    <td>{{ "%.2f"|format(m.f1_score) }}</td>
                    <td>{% if m.is_active %}<strong>Active</strong>{% else %}&mdash;{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <p>No model profile configured.</p>
        <p style="margin-top: 8px;"><a href="/setup" class="btn btn-primary">Set up a model</a></p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    /* Save profile */
    var saveBtn = document.getElementById('saveProfileBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            var data = {
                description: document.getElementById('profileDesc').value.trim(),
            };
            fetch('/api/model/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (d.success) flash('Profile saved.', 'success');
                else flash(d.error || 'Failed.', 'error');
            })
            .catch(function(err) { flash('Error: ' + err.message, 'error'); });
        });
    }

    /* Export */
    var exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            var status = document.getElementById('exportStatus');
            status.textContent = 'Preparing...';
            exportBtn.disabled = true;

            fetch('/api/model/export')
            .then(function(r) {
                if (!r.ok) throw new Error('Export failed');
                var filename = 'model.magnitu';
                var cd = r.headers.get('Content-Disposition');
                if (cd) {
                    var match = cd.match(/filename="?([^"]+)"?/);
                    if (match) filename = match[1];
                }
                return r.blob().then(function(blob) {
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                    status.textContent = 'Downloaded.';
                    exportBtn.disabled = false;
                });
            })
            .catch(function(err) {
                status.textContent = 'Error: ' + err.message;
                exportBtn.disabled = false;
            });
        });
    }

    /* Fork (Export as New Model) */
    var forkBtn = document.getElementById('forkBtn');
    if (forkBtn) {
        forkBtn.addEventListener('click', function() {
            var name = document.getElementById('forkName').value.trim();
            var desc = document.getElementById('forkDesc').value.trim();
            var status = document.getElementById('forkStatus');
            if (!name) { flash('Enter a name for the new model.', 'error'); return; }
            status.textContent = 'Preparing...';
            forkBtn.disabled = true;

            fetch('/api/model/fork', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, description: desc }),
            })
            .then(function(r) {
                if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'Failed'); });
                var filename = name.replace(/\s+/g, '_').toLowerCase() + '.magnitu';
                var cd = r.headers.get('Content-Disposition');
                if (cd) {
                    var match = cd.match(/filename="?([^"]+)"?/);
                    if (match) filename = match[1];
                }
                return r.blob().then(function(blob) {
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                    status.textContent = 'Downloaded.';
                    forkBtn.disabled = false;
                });
            })
            .catch(function(err) {
                status.textContent = 'Error: ' + err.message;
                forkBtn.disabled = false;
            });
        });
    }

    /* Import */
    var importForm = document.getElementById('importForm');
    if (importForm) {
        importForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) { flash('Select a .magnitu file.', 'error'); return; }

            var formData = new FormData();
            formData.append('file', fileInput.files[0]);

            var status = document.getElementById('importStatus');
            status.innerHTML = '<span class="message message-info" style="display:inline-block; padding:4px 10px;">Importing...</span>';

            fetch('/api/model/import', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (d.success) {
                    status.innerHTML = '<span class="message message-success" style="display:inline-block; padding:4px 10px;">' + (d.message || 'Imported.') + '</span>';
                    setTimeout(function() { location.reload(); }, 2000);
                } else {
                    status.innerHTML = '<span class="message message-error" style="display:inline-block; padding:4px 10px;">' + (d.error || 'Failed.') + '</span>';
                }
            })
            .catch(function(err) {
                status.innerHTML = '<span class="message message-error" style="display:inline-block; padding:4px 10px;">Error: ' + err.message + '</span>';
            });
        });
    }
})();
</script>
{% endblock %}
